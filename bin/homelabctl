#!/usr/bin/env bash
set -euo pipefail

# 解析脚本真实路径
homelabctl_resolve_script_dir() {
    local src="${BASH_SOURCE[0]}"
    while [[ -L "$src" ]]; do
        local dir
        dir="$(cd -P "$(dirname "$src")" && pwd)"
        src="$(readlink "$src")"
        [[ "$src" != /* ]] && src="$dir/$src"
    done
    cd -P "$(dirname "$src")" && pwd
}

# 获取项目根目录
homelabctl_get_project_root() {
    local bin_dir
    bin_dir=$(homelabctl_resolve_script_dir)
    dirname "$bin_dir"
}

# 解析全局选项 (--verbose, --debug)
# 返回: 设置环境变量并输出过滤后的参数
homelabctl_parse_global_opts() {
    local -a filtered_args=()
    local verbose=false
    local debug=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -v|--verbose)
                verbose=true
                shift
                ;;
            --debug)
                debug=true
                shift
                ;;
            --)
                shift
                filtered_args+=("$@")
                break
                ;;
            *)
                filtered_args+=("$1")
                shift
                ;;
        esac
    done

    # 设置输出模式环境变量
    if [[ "$debug" == "true" ]]; then
        # Debug 模式: banner on, log level debug, debug enabled
        export GX_RADP_FW_BANNER_MODE=on
        export GX_RADP_FW_LOG_LEVEL=debug
        export GX_RADP_FW_LOG_DEBUG=true
    elif [[ "$verbose" == "true" ]]; then
        # Verbose 模式: banner on, log level info
        export GX_RADP_FW_BANNER_MODE=on
        export GX_RADP_FW_LOG_LEVEL=info
    else
        # 默认模式: banner off, log level error (只显示错误)
        export GX_RADP_FW_BANNER_MODE=off
        export GX_RADP_FW_LOG_LEVEL=error
    fi

    # 输出过滤后的参数 (用 null 分隔以处理特殊字符)
    # 注意：当数组为空时不输出任何内容
    if [[ ${#filtered_args[@]} -gt 0 ]]; then
        printf '%s\0' "${filtered_args[@]}"
    fi
}

# 主函数
homelabctl_main() {
    local project_root
    project_root=$(homelabctl_get_project_root)

    # 加载 radp-bash-framework
    if ! command -v radp-bf &>/dev/null; then
        echo "Error: radp-bash-framework not found. Please install it first." >&2
        echo "  See: https://github.com/xooooooooox/radp-bash-framework" >&2
        exit 1
    fi

    # 解析全局选项并获取过滤后的参数
    local -a args=()
    while IFS= read -r -d '' arg; do
        args+=("$arg")
    done < <(homelabctl_parse_global_opts "$@")

    # 生成补全脚本时禁用所有输出
    if [[ "${args[0]:-}" == "completion" ]]; then
        export GX_RADP_FW_BANNER_MODE=off
        export GX_RADP_FW_LOG_CONSOLE_ENABLED=false
    fi

    # 设置用户配置路径（在加载 framework 之前）
    export GX_RADP_FW_USER_CONFIG_PATH="$project_root/src/main/shell/config"

    # shellcheck source=/dev/null
    source "$(radp-bf --print-run)"

    # 设置应用信息
    radp_cli_set_app_name "homelabctl"
    radp_cli_set_commands_dir "$project_root/src/main/shell/commands"

    # 设置 radp-vagrant-framework 相关路径
    export HOMELABCTL_ROOT="$project_root"

    # 加载版本常量
    # shellcheck source=/dev/null
    source "$project_root/src/main/shell/vars/constants.sh"

    # 加载项目私有库（如果存在）
    if [[ -d "$project_root/src/main/shell/libs" ]]; then
        local lib_file
        while IFS= read -r -d '' lib_file; do
            # shellcheck source=/dev/null
            source "$lib_file"
        done < <(find "$project_root/src/main/shell/libs" -type f -name "*.sh" -print0 | sort -z)
    fi

    # 运行
    # 当没有参数时，显示帮助
    if [[ ${#args[@]} -eq 0 ]]; then
        radp_app_run --help
    else
        radp_app_run "${args[@]}"
    fi
}

homelabctl_main "$@"
