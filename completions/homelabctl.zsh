#compdef homelabctl

# homelabctl completion helper functions

_homelabctl_complete_packages() {
  homelabctl -q setup list --names-only 2>/dev/null
}

_homelabctl_complete_categories() {
  homelabctl -q setup list --category-names 2>/dev/null
}

_homelabctl_complete_profiles() {
  homelabctl -q setup profile list --names-only 2>/dev/null
}


# Zsh completion script for homelabctl
# Generated by radp-bash-framework

_homelabctl_arg_setup_deps_name() {
    local completions=($(_homelabctl_complete_packages 2>/dev/null))
    _describe 'name' completions
}

_homelabctl_arg_setup_info_name() {
    local completions=($(_homelabctl_complete_packages 2>/dev/null))
    _describe 'name' completions
}

_homelabctl_arg_setup_install_name() {
    local completions=($(_homelabctl_complete_packages 2>/dev/null))
    _describe 'name' completions
}

_homelabctl_opt_setup_list_category() {
    local completions=($(_homelabctl_complete_categories 2>/dev/null))
    _describe 'name' completions
}

_homelabctl_arg_setup_profile_apply_name() {
    local completions=($(_homelabctl_complete_profiles 2>/dev/null))
    _describe 'name' completions
}

_homelabctl_arg_setup_profile_show_name() {
    local completions=($(_homelabctl_complete_profiles 2>/dev/null))
    _describe 'name' completions
}

_homelabctl_completion() {
    _arguments -s \
        '(-h --help)'{-h,--help}'[Show help]' \
        '1:shell:_files'
}

_homelabctl_info() {
    _arguments -s \
        '(-h --help)'{-h,--help}'[Show help]' \
        '(-j --json)'{-j,--json}'[Output as JSON]' \
        '*:file:_files'
}

_homelabctl_setup() {
    local context state state_descr line
    typeset -A opt_args

    _arguments -C \
        '(-h --help)'{-h,--help}'[Show help]' \
        '1: :->command' \
        '*:: :->args'

    case "$state" in
        command)
            local commands=(
                'configure:Manage configure'
                'deps:Show package dependency tree'
                'info:Show package details'
                'install:Install a software package'
                'list:List available packages'
                'profile:Manage profile'
            )
            _describe 'subcommand' commands
            ;;
        args)
            local cmd_func="_homelabctl_setup_${words[1]//-/_}"
            if (( $+functions[$cmd_func] )); then
                $cmd_func
            else
                _files
            fi
            ;;
    esac
}

_homelabctl_setup_configure() {
    local context state state_descr line
    typeset -A opt_args

    _arguments -C \
        '(-h --help)'{-h,--help}'[Show help]' \
        '1: :->command' \
        '*:: :->args'

    case "$state" in
        command)
            local commands=(
                'chrony:Configure chrony for time synchronization'
                'expand-lvm:Expand LVM partition and filesystem to use all available disk space'
                'gpg-import:Import GPG keys into user keyring'
                'gpg-preset:Preset GPG passphrase in gpg-agent cache for non-interactive operations'
                'list:List available system configurations'
                'yadm:Clone dotfiles repository using yadm'
            )
            _describe 'subcommand' commands
            ;;
        args)
            local cmd_func="_homelabctl_setup_configure_${words[1]//-/_}"
            if (( $+functions[$cmd_func] )); then
                $cmd_func
            else
                _files
            fi
            ;;
    esac
}

_homelabctl_setup_configure_chrony() {
    _arguments -s \
        '(-h --help)'{-h,--help}'[Show help]' \
        '(-s --servers)'{-s,--servers}'[Comma-separated NTP servers (e.g., "ntp.aliyun.com,ntp1.aliyun.com")]:list:' \
        '(-p --pool)'{-p,--pool}'[NTP pool to use if servers not specified (default: pool.ntp.org)]:pool:' \
        '(-t --timezone)'{-t,--timezone}'[Timezone to set (e.g., "Asia/Shanghai")]:tz:' \
        '*:file:_files'
}

_homelabctl_setup_configure_expand_lvm() {
    _arguments -s \
        '(-h --help)'{-h,--help}'[Show help]' \
        '(-p --partition)'{-p,--partition}'[LVM partition to expand (e.g., /dev/sda3). Auto-detected if not specified.]:dev:' \
        '(-v --vg)'{-v,--vg}'[Volume group name. Auto-detected if not specified.]:name:' \
        '(-l --lv)'{-l,--lv}'[Logical volume to expand. Auto-detected if not specified.]:name:' \
        '*:file:_files'
}

_homelabctl_setup_configure_gpg_import() {
    _arguments -s \
        '(-h --help)'{-h,--help}'[Show help]' \
        '(-p --public-key)'{-p,--public-key}'[GPG public key content (ASCII-armored)]:content:' \
        '(-p --public-key-file)'{-p,--public-key-file}'[Path to GPG public key file]:file:' \
        '(-s --secret-key-file)'{-s,--secret-key-file}'[Path to GPG secret key file]:file:' \
        '(-p --passphrase)'{-p,--passphrase}'[Passphrase for secret key]:pass:' \
        '(-p --passphrase-file)'{-p,--passphrase-file}'[Path to file containing passphrase]:file:' \
        '(-k --key-id)'{-k,--key-id}'[GPG key ID to fetch from keyserver]:id:' \
        '(-k --keyserver)'{-k,--keyserver}'[Keyserver URL (default: keys.openpgp.org)]:url:' \
        '(-t --trust-level)'{-t,--trust-level}'[Trust level (2=unknown, 3=marginal, 4=full, 5=ultimate)]:level:' \
        '(-o --ownertrust-file)'{-o,--ownertrust-file}'[Path to ownertrust file]:file:' \
        '(-u --user)'{-u,--user}'[Target user (default: current user, requires sudo for other users)]:name:' \
        '*:file:_files'
}

_homelabctl_setup_configure_gpg_preset() {
    _arguments -s \
        '(-h --help)'{-h,--help}'[Show help]' \
        '(-k --key-uid)'{-k,--key-uid}'[Key UID (email) to identify the key (e.g., user@example.com)]:uid:' \
        '(-p --passphrase)'{-p,--passphrase}'[Passphrase content]:pass:' \
        '(-p --passphrase-file)'{-p,--passphrase-file}'[Path to file containing passphrase]:file:' \
        '(-u --user)'{-u,--user}'[Target user (default: current user, requires sudo for other users)]:name:' \
        '*:file:_files'
}

_homelabctl_setup_configure_list() {
    _arguments -s \
        '(-h --help)'{-h,--help}'[Show help]' \
        '*:file:_files'
}

_homelabctl_setup_configure_yadm() {
    _arguments -s \
        '(-h --help)'{-h,--help}'[Show help]' \
        '(-r --repo-url)'{-r,--repo-url}'[Dotfiles repository URL (HTTPS or SSH format)]:url:' \
        '(-c --class)'{-c,--class}'[Set yadm class before clone]:class:' \
        '(-h --https-user)'{-h,--https-user}'[Username for HTTPS authentication]:user:' \
        '(-h --https-token)'{-h,--https-token}'[Personal access token for HTTPS authentication]:token:' \
        '(-h --https-token-file)'{-h,--https-token-file}'[Path to file containing access token]:file:' \
        '(-s --ssh-key-file)'{-s,--ssh-key-file}'[Path to SSH private key file]:file:' \
        '(-s --ssh-host)'{-s,--ssh-host}'[Override SSH hostname/IP (for private servers)]:host:' \
        '(-s --ssh-port)'{-s,--ssh-port}'[Override SSH port (default 22)]:port:' \
        '(-u --user)'{-u,--user}'[Target user (default: current user, requires sudo for other users)]:name:' \
        '*:file:_files'
}

_homelabctl_setup_deps() {
    _arguments -s \
        '(-h --help)'{-h,--help}'[Show help]' \
        '(-r --reverse)'{-r,--reverse}'[Show reverse dependencies (packages that depend on this one)]' \
        '1:name:_homelabctl_arg_setup_deps_name'
}

_homelabctl_setup_info() {
    _arguments -s \
        '(-h --help)'{-h,--help}'[Show help]' \
        '(-a --all-platforms)'{-a,--all-platforms}'[Show dependencies for all platforms]' \
        '1:name:_homelabctl_arg_setup_info_name'
}

_homelabctl_setup_install() {
    _arguments -s \
        '(-h --help)'{-h,--help}'[Show help]' \
        '(-v --version)'{-v,--version}'[Specific version (default: latest)]:ver:' \
        '(-d --dry-run)'{-d,--dry-run}'[Show what would be installed without installing]' \
        '(-n --no-deps)'{-n,--no-deps}'[Skip automatic dependency installation]' \
        '1:name:_homelabctl_arg_setup_install_name'
}

_homelabctl_setup_list() {
    _arguments -s \
        '(-h --help)'{-h,--help}'[Show help]' \
        '(-c --category)'{-c,--category}'[Filter by category]:name:_homelabctl_opt_setup_list_category' \
        '(-i --installed)'{-i,--installed}'[Show only installed packages]' \
        '(-c --categories)'{-c,--categories}'[List available categories]' \
        '(-n --names-only)'{-n,--names-only}'[Output package names only (for completion)]' \
        '(-c --category-names)'{-c,--category-names}'[Output category names only (for completion)]' \
        '*:file:_files'
}

_homelabctl_setup_profile() {
    local context state state_descr line
    typeset -A opt_args

    _arguments -C \
        '(-h --help)'{-h,--help}'[Show help]' \
        '1: :->command' \
        '*:: :->args'

    case "$state" in
        command)
            local commands=(
                'apply:Apply a setup profile (install multiple packages)'
                'list:List available setup profiles'
                'show:Show profile details'
            )
            _describe 'subcommand' commands
            ;;
        args)
            local cmd_func="_homelabctl_setup_profile_${words[1]//-/_}"
            if (( $+functions[$cmd_func] )); then
                $cmd_func
            else
                _files
            fi
            ;;
    esac
}

_homelabctl_setup_profile_apply() {
    _arguments -s \
        '(-h --help)'{-h,--help}'[Show help]' \
        '(-d --dry-run)'{-d,--dry-run}'[Show what would be installed]' \
        '(-c --continue)'{-c,--continue}'[Continue on error]' \
        '(-s --skip-installed)'{-s,--skip-installed}'[Skip already installed packages]' \
        '(-n --no-deps)'{-n,--no-deps}'[Skip automatic dependency installation]' \
        '1:name:_homelabctl_arg_setup_profile_apply_name'
}

_homelabctl_setup_profile_list() {
    _arguments -s \
        '(-h --help)'{-h,--help}'[Show help]' \
        '(-n --names-only)'{-n,--names-only}'[Output profile names only (for completion)]' \
        '*:file:_files'
}

_homelabctl_setup_profile_show() {
    _arguments -s \
        '(-h --help)'{-h,--help}'[Show help]' \
        '1:name:_homelabctl_arg_setup_profile_show_name'
}

_homelabctl_version() {
    _arguments -s \
        '(-h --help)'{-h,--help}'[Show help]' \
        '*:file:_files'
}

_homelabctl_vf() {
    _arguments '(-h --help)'{-h,--help}'[Show help]' '*:args:'
}

_homelabctl() {
    local context state state_descr line
    typeset -A opt_args

    _arguments -C \
        '(-h --help)'{-h,--help}'[Show help]' \
        '--version[Show version]' \
        '-q' \
        '--quiet' \
        '(-v --verbose)'{-v,--verbose}'[Enable verbose output]' \
        '--debug[Enable debug output]' \
        '--config' \
        '1: :->command' \
        '*:: :->args'

    case "$state" in
        command)
            local commands=(
                'completion:Generate shell completion script'
                'info:Show homelabctl environment information'
                'setup:Manage setup'
                'version:Show version information'
                'vf:Run radp-vagrant-framework commands (passthrough to radp-vf)'
            )
            _describe 'command' commands
            ;;
        args)
            local cmd_func="_homelabctl_${words[1]//-/_}"
            if (( $+functions[$cmd_func] )); then
                $cmd_func
            else
                _files
            fi
            ;;
    esac
}

_homelabctl "$@"

# Override _homelabctl_vg to delegate to vagrant's native completion
_homelabctl_vg() {
    # Delegate to vagrant's native completion for consistent experience
    if (( $+functions[_vagrant] )); then
        _vagrant "$@"
    else
        # Fallback if vagrant completion not loaded
        local -a vagrant_cmds=(
            'up:Start and provision VMs'
            'halt:Stop VMs'
            'destroy:Destroy VMs'
            'status:Show VM status'
            'ssh:SSH into VM'
            'provision:Run provisioners'
            'reload:Restart VMs'
            'suspend:Suspend VMs'
            'resume:Resume suspended VMs'
            'snapshot:Manage snapshots'
        )
        _arguments -s \
            '1: :->vagrant_cmd' \
            '*:: :->vagrant_args'

        case "$state" in
            vagrant_cmd)
                _describe -t commands 'vagrant command' vagrant_cmds
                ;;
            vagrant_args)
                _files
                ;;
        esac
    fi
}
